; platformio.ini - VSCode + PlatformIO optimized dual target configuration
[platformio]
default_envs = desktop    ; Start with simulator for fast development
src_dir = src
include_dir = include
lib_dir = lib
data_dir = data

; Common settings shared between environments
[env]
lib_deps = 
    lvgl/lvgl@9.3.0                     ; Pinned version
build_flags = 
    -D LV_CONF_PATH="\"${PROJECT_INCLUDE_DIR}/lv_conf.h\""
    -I include
    -D LV_CONF_INCLUDE_SIMPLE
    -I ${PROJECT_INCLUDE_DIR}
    -I ${PROJECT_SRC_DIR}
    -std=c++17
    -Wall
    -Wextra
    -Isrc/components
    -Isrc/components/controls
    -Isrc/components/parameter
    -Isrc/components/layout
    -Isrc/components/app
    -Isrc/hardware
    -Isrc/include
    -Iinclude/
    -Isrc/assets/fonts
    -Iassets
    -Isrc
build_unflags = 
    -std=gnu++11

; ========================================
; DESKTOP SIMULATOR ENVIRONMENT
; ========================================
[env:desktop]
platform = native
build_flags = 
    ${env.build_flags}              
    -D LV_USE_LOG=1
    -D LV_LOG_LEVEL=LV_LOG_LEVEL_INFO
    -D LV_USE_SDL=1
    -std=c++17
    -pthread
    !pkg-config --cflags sdl2
    !pkg-config --libs sdl2
    !pkg-config --cflags --libs alsa    ; For RtMidi on Linux
    -D__LINUX_ALSA__                    ; Tell RtMidi to use ALSA backend
    -D__LITTLE_ENDIAN__                 ; Linux endianness
    -DHAVE_GETTIMEOFDAY                 ; Linux timing

lib_deps = 
    lvgl/lvgl@9.3.0                     ; Pinned version
    ; RtMidi will be installed by our build script
    file://lib/rtmidi_linux

# Remove all the complex exclusions - not needed with clean library
build_src_filter = 
    +<*> 
    -<hardware/ESP32Display.cpp>
    -<hardware/LGFX_ST7796S.h>
    -<hardware/ESP32MidiInterface.cpp>
    -<test_helpers/*>

build_unflags =
    -std=gnu++11

lib_ldf_mode = off    ; Disable automatic dependency finding (fastest)
lib_compat_mode = strict    ; Only compatible libraries
lib_archive = yes          ; Use library archives for faster builds

# Run our RtMidi installation script BEFORE dependency resolution
extra_scripts = 
    pre:scripts/install_rtmidi.py

build_type = debug
monitor_flags = 
    --echo

; ========================================
; ESP32-S3 HARDWARE ENVIRONMENT  
; ========================================
[env:rymcu-esp32-s3-devkitc-1]
platform = espressif32@^6.4.0
platform_packages = 
    toolchain-xtensa-esp32s3@8.4.0+2021r2-patch5
board = esp32-s3-devkitc-1-n16r8v
framework = arduino
monitor_speed = 115200
monitor_filters = esp32_exception_decoder
upload_speed = 921600
build_flags = 
    ; ${env.build_flags}
    -D ESP32_BUILD=1                 ; This disables SDL in lv_conf.h
    -D BOARD_HAS_PSRAM
    -D CONFIG_SPIRAM_USE_CAPS_ALLOC=1
    -D LV_USE_LOG=1
    -D LV_LOG_LEVEL=LV_LOG_LEVEL_INFO
    -D LV_TICK_CUSTOM=1
    -D LV_MEM_CUSTOM=1
    -D CORE_DEBUG_LEVEL=3
    -I include/

lib_deps = 
    ${env.lib_deps}
    bodmer/TFT_eSPI@2.5.43                           ; Pinned version
    https://github.com/lovyan03/LovyanGFX.git#5438181 ; Pinned to specific commit
    https://github.com/tttapa/Control-Surface.git#f85f2e3 ; Pinned to specific commit

lib_ignore = 
    MIDIUSB  ; Ignore the Arduino MIDIUSB library - Control-Surface has ESP32 support
    rtmidi_linux           ; Ignore RtMidi - only for desktop builds

build_src_filter = 
    +<*>
    -<hal/desktop/>
    +<hal/esp32/>
    -<**/test_helpers/>              ; Exclude test_helpers in any subdirectory

check_tool = cppcheck
check_flags = 
    cppcheck: --enable=all --std=c++17

; ========================================
; ESP32-S3 DEBUG ENVIRONMENT (with JTAG)
; ========================================
[env:rymcu-esp32-s3-devkitc-1-debug]
extends = env:rymcu-esp32-s3-devkitc-1
debug_tool = esp-builtin
debug_init_break = tbreak setup
build_type = debug
build_flags = 
    ${env:rymcu-esp32-s3-devkitc-1.build_flags}
    -O0                               ; No optimization for debugging
    -g3                               ; Full debug info
    -DDEBUG=1

lib_deps = 
    lvgl/lvgl@9.3.0                                  ; Pinned version
    bodmer/TFT_eSPI@2.5.43                           ; Pinned version
    https://github.com/lovyan03/LovyanGFX.git#5438181 ; Pinned to specific commit
    https://github.com/tttapa/Control-Surface.git#f85f2e3 ; Pinned to specific commit

; ========================================
; EXPERIMENTAL: Arduino Core 3.x with pioarduino fork
; ========================================
[env:rymcu-esp32-s3-arduino3x-test]
platform = https://github.com/pioarduino/platform-espressif32/releases/download/stable/platform-espressif32.zip
platform_packages = 
    toolchain-xtensa-esp32s3@8.4.0+2021r2-patch5
board = esp32-s3-devkitc-1-n16r8v
monitor_port = /dev/ttyACM1  ; or whichever /dev/ttyACM* matches your Espressif device
framework = arduino
monitor_speed = 115200
monitor_filters = esp32_exception_decoder
upload_speed = 921600
build_flags = 
    -D ESP32_BUILD=1
    -D BOARD_HAS_PSRAM
    -D CONFIG_SPIRAM_USE_CAPS_ALLOC=1
    -D LV_USE_LOG=1
    -D LV_LOG_LEVEL=LV_LOG_LEVEL_INFO
    -D LV_TICK_CUSTOM=1
    -D LV_MEM_CUSTOM=1
    -D CORE_DEBUG_LEVEL=3
    -D ARDUINO_USB_MODE=0              # Enable native USB-OTG mode (0 = USB-OTG)
    -D ARDUINO_USB_CDC_ON_BOOT=0       # Disable CDC completely
    -D USE_TINYUSB                     # Enable TinyUSB stack 
    -D CFG_TUD_MIDI=1                  # Enable TinyUSB MIDI device
    -D CFG_TUD_MIDI_EP_BUFSIZE=64      # MIDI endpoint buffer size
    -D CFG_TUD_CDC=0                   # Disable CDC completely
    -D ARDUINO_USB_MSC_ON_BOOT=0       # Disable MSC
    -D ARDUINO_USB_DFU_ON_BOOT=0       # Disable DFU
    -D CORE_DEBUG_LEVEL=1              # Enable error logging
    -I include/

lib_deps = 
    ${env.lib_deps}
    bodmer/TFT_eSPI@2.5.43
    ; https://github.com/lovyan03/LovyanGFX.git#5438181 ; Use pinned commit that works with Arduino Core 3.x
    lovyan03/LovyanGFX@^1.1.16
    https://github.com/tttapa/Control-Surface.git ; Add Control-Surface back

lib_ignore = 
    MIDIUSB
    rtmidi_linux

build_src_filter = 
    +<*>
    -<hal/desktop/>
    +<hal/esp32/>
    -<**/test_helpers/>
    -<test_*.cpp>                    ; Exclude test files for now