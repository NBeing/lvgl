; platformio.ini - VSCode + PlatformIO optimized dual target configuration
[platformio]
default_envs = desktop    ; Start with simulator for fast development
src_dir = src
include_dir = include
lib_dir = lib
data_dir = data

; Common settings shared between environments
[env]
lib_deps = 
    lvgl/lvgl@^9.2.0
build_flags = 
    -D LV_CONF_INCLUDE_SIMPLE
    -I ${PROJECT_INCLUDE_DIR}
    -I ${PROJECT_SRC_DIR}
    -std=c++17
    -Wall
    -Wextra
build_unflags = 
    -std=gnu++11

; ========================================
; DESKTOP SIMULATOR ENVIRONMENT
; ========================================
[env:desktop]
platform = native@^1.2.1
extra_scripts = 
    pre:scripts/install_sdl.py       ; Auto-install SDL2 if needed
build_flags = 
    ${env.build_flags}
    -D DESKTOP_BUILD=1
    -D LV_USE_LOG=1
    -D LV_LOG_LEVEL=LV_LOG_LEVEL_INFO
    -D SDL_MAIN_HANDLED
    -D LV_TICK_CUSTOM=0              ; Override to prevent redefinition
    ; Platform-specific SDL2 flags (auto-detected by script)
    !python scripts/get_sdl_flags.py
lib_deps = 
    ${env.lib_deps}
build_src_filter = 
    +<*>
    -<hal/esp32/>          ; Exclude ESP32-specific code
    +<hal/desktop/>        ; Include desktop HAL
    -<*.ino>               ; Exclude Arduino files
check_tool = cppcheck, clangtidy
check_flags = 
    cppcheck: --enable=all --std=c++17
    clangtidy: --checks=-*,readability-*,performance-*

; ========================================
; ESP32-S3 HARDWARE ENVIRONMENT  
; ========================================
[env:rymcu-esp32-s3-devkitc-1]
platform = espressif32@^6.4.0
platform_packages = 
    toolchain-xtensa-esp32s3@8.4.0+2021r2-patch5
;     framework-arduinoespressif32@2.0.11
board = esp32-s3-devkitc-1-n16r8v
framework = arduino
monitor_speed = 115200
monitor_filters = esp32_exception_decoder
upload_speed = 921600
build_flags = 
    ${env.build_flags}
    -D ESP32_BUILD=1
    -D ARDUINO_ESP32S3_DEV
    -D CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240=1
    -D BOARD_HAS_PSRAM                       ; Your board has 8MB PSRAM
    -D CONFIG_SPIRAM_USE_CAPS_ALLOC=1        ; Enable PSRAM allocation
    -D LV_USE_LOG=1
    -D LV_LOG_LEVEL=LV_LOG_LEVEL_INFO
    -D LV_TICK_CUSTOM=1                      ; Use custom tick for LVGL
    -D LV_MEM_CUSTOM=1                       ; Use ESP32 memory management
    -D CORE_DEBUG_LEVEL=3                    ; Enable detailed debugging
lib_deps = 
    ${env.lib_deps}
    bodmer/TFT_eSPI@^2.5.43
    https://github.com/lovyan03/LovyanGFX.git
    ; Optional: Add your preferred MIDI library
    ; FortySevenEffects/MIDI Library@^5.0.2
build_src_filter = 
    +<*>
    -<hal/desktop/>        ; Exclude desktop HAL
    +<hal/esp32/>          ; Include ESP32 HAL
check_tool = cppcheck
check_flags = 
    cppcheck: --enable=all --std=c++17

; ========================================
; ESP32-S3 DEBUG ENVIRONMENT (with JTAG)
; ========================================
[env:rymcu-esp32-s3-devkitc-1-debug]
extends = env:rymcu-esp32-s3-devkitc-1
debug_tool = esp-builtin
debug_init_break = tbreak setup
build_type = debug
build_flags = 
    ${env:rymcu-esp32-s3-devkitc-1.build_flags}
    -O0                               ; No optimization for debugging
    -g3                               ; Full debug info
    -DDEBUG=1
lib_deps = 
    lvgl/lvgl@^9.2.0
    bodmer/TFT_eSPI@^2.5.43
    https://github.com/lovyan03/LovyanGFX.git